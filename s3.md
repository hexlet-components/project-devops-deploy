Ниже — **практическое, простое и рабочее** руководство, как в Spring Boot сделать загрузку и получение картинок в Amazon S3, чтобы React Admin мог их отображать.

---

# ✅ Архитектура (как должно работать)

### **Backend (Spring Boot)**

* Принимает `MultipartFile`.
* Загружает файл в S3 (например, в папку `/images/`).
* Возвращает фронтенду URL картинки (обычно pre-signed URL).
* Может отдавать pre-signed URL для просмотра/скачивания.

### **Frontend (React Admin)**

* При загрузке отправляет файл на ваш бэкенд `/api/upload`.
* В форму ресурса пишет пришедший URL.

---

# ✅ 1. Зависимости для AWS SDK

Используй AWS SDK v2 или v1. v2 проще и современнее:

```xml
<dependency>
    <groupId>software.amazon.awssdk</groupId>
    <artifactId>s3</artifactId>
</dependency>
```

---

# ✅ 2. Настройки (application.yml)

```yaml
aws:
  region: eu-central-1
  s3:
    bucket: my-bucket-name
```

И передаёшь AWS key/secret через переменные окружения:

```
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
```

---

# ✅ 3. Конфигурация S3 клиента

```java
@Configuration
public class S3Config {

    @Bean
    public S3Client s3Client() {
        return S3Client.builder()
                .region(Region.of("eu-central-1"))
                .build();
    }
}
```

---

# ✅ 4. Сервис загрузки файлов

```java
@Service
@RequiredArgsConstructor
public class S3Service {

    private final S3Client s3Client;

    @Value("${aws.s3.bucket}")
    private String bucket;

    public String upload(MultipartFile file) throws IOException {
        String key = "images/" + UUID.randomUUID() + "-" + file.getOriginalFilename();

        PutObjectRequest request = PutObjectRequest.builder()
                .bucket(bucket)
                .key(key)
                .contentType(file.getContentType())
                .acl("public-read") // либо убрать и использовать pre-signed URL
                .build();

        s3Client.putObject(request,
                RequestBody.fromBytes(file.getBytes()));

        return key;
    }

    /** Выдаём pre-signed URL для отображения картинки */
    public String generatePresignedUrl(String key) {
        S3Presigner presigner = S3Presigner.builder()
                .region(Region.of("eu-central-1"))
                .build();

        GetObjectRequest getObjectRequest =
                GetObjectRequest.builder()
                        .bucket(bucket)
                        .key(key)
                        .build();

        PresignedGetObjectRequest presigned = presigner.presignGetObject(
                r -> r.getObjectRequest(getObjectRequest)
                        .signatureDuration(Duration.ofHours(1))
        );

        return presigned.url().toString();
    }
}
```

---

# ✅ 5. Контроллер загрузки

```java
@RestController
@RequestMapping("/api/files")
@RequiredArgsConstructor
public class FileController {

    private final S3Service s3Service;

    @PostMapping("/upload")
    public Map<String, String> upload(@RequestParam("file") MultipartFile file) throws IOException {
        String key = s3Service.upload(file);
        String url = s3Service.generatePresignedUrl(key);

        return Map.of(
                "key", key,
                "url", url
        );
    }

    @GetMapping("/view")
    public Map<String, String> view(@RequestParam("key") String key) {
        return Map.of(
                "url", s3Service.generatePresignedUrl(key)
        );
    }
}
```

---

# ✅ 6. React Admin: как подключить загрузку изображений

Пример `ImageInput`:

```jsx
<ImageInput source="image" label="Upload image" accept="image/*">
    <ImageField source="src" title="title" />
</ImageInput>
```

И в датапровайдере:

```javascript
const dataProvider = {
    create: (resource, params) => {
        const file = params.data.image.rawFile;

        const formData = new FormData();
        formData.append("file", file);

        return fetch("/api/files/upload", {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(({ key, url }) => {
                return {
                    data: {
                        ...params.data,
                        imageKey: key,
                        imageUrl: url
                    }
                }
            });
    },
    ...
}
```

---

# ❗ Советы для боевого проекта

* Не делайте S3 объекты public; лучше только через pre-signed URLs.
* Сгенерированный key сохраняй в базе (например, поле `imageKey` у объявления).
* URL генерируй каждый раз при запросе данных.
* Ограничивай размер файла (`spring.servlet.multipart.max-file-size`).
